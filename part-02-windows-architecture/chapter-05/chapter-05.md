# Chapter 5: íŒŒì¼ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

## ë‚œì´ë„: â­â­â­ (ì¤‘ê¸‰)

## í•™ìŠµ ëª©í‘œ

- I/O Managerì™€ IRPì˜ ì—­í•  ì´í•´
- íŒŒì¼ ì‹œìŠ¤í…œ ë“œë¼ì´ë²„ ìŠ¤íƒ êµ¬ì¡° íŒŒì•…
- Filter Managerì™€ Minifilter ê´€ê³„ ì´í•´
- íŒŒì¼ I/O ìš”ì²­ì˜ ì „ì²´ íë¦„ íŒŒì•…

---

## ë“¤ì–´ê°€ë©°

.NETì—ì„œ `File.ReadAllText("test.txt")`ë¥¼ í˜¸ì¶œí•˜ë©´ ë‚´ë¶€ì—ì„œ ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚ ê¹Œìš”? ì´ ê°„ë‹¨í•œ í•œ ì¤„ ë’¤ì—ëŠ” ì—¬ëŸ¬ ì»¤ë„ ì»´í¬ë„ŒíŠ¸ê°€ í˜‘ë ¥í•˜ì—¬ íŒŒì¼ì„ ì½ì–´ì˜µë‹ˆë‹¤.

ì´ ì¥ì—ì„œëŠ” íŒŒì¼ I/Oê°€ ì–´ë–»ê²Œ ì²˜ë¦¬ë˜ëŠ”ì§€, ê·¸ë¦¬ê³  **Minifilterê°€ ì–´ë””ì— ìœ„ì¹˜í•˜ì—¬ ìš”ì²­ì„ ê°€ë¡œì±„ëŠ”ì§€** ì´í•´í•©ë‹ˆë‹¤.

---

## 5.1 I/O Manager

### 5.1.1 I/O Managerì˜ ì—­í• 

I/O ManagerëŠ” Windowsì˜ ëª¨ë“  ì…ì¶œë ¥ì„ ê´€ë¦¬í•˜ëŠ” í•µì‹¬ ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤:

```
I/O Managerì˜ ì£¼ìš” ì—­í• :
â”œâ”€â”€ IRP (I/O Request Packet) ìƒì„± ë° ê´€ë¦¬
â”œâ”€â”€ ë“œë¼ì´ë²„ ìŠ¤íƒìœ¼ë¡œ ìš”ì²­ ì „ë‹¬
â”œâ”€â”€ ì™„ë£Œ ë£¨í‹´ í˜¸ì¶œ
â”œâ”€â”€ ë¹„ë™ê¸° I/O ì§€ì›
â””â”€â”€ Fast I/O ê²½ë¡œ ì œê³µ
```

### C# ë¹„ìœ 

```csharp
// I/O Manager â‰ˆ ASP.NET Coreì˜ ë¯¸ë“¤ì›¨ì–´ íŒŒì´í”„ë¼ì¸
// I/O Manager â‰ˆ ASP.NET Core middleware pipeline
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

// ìš”ì²­ì´ íŒŒì´í”„ë¼ì¸ì„ í†µê³¼
app.Use(async (context, next) =>
{
    // Pre-processing (Pre-operation callbackê³¼ ìœ ì‚¬)
    Console.WriteLine("ìš”ì²­ ì „ì²˜ë¦¬");

    await next();  // ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ë¡œ ì „ë‹¬

    // Post-processing (Post-operation callbackê³¼ ìœ ì‚¬)
    Console.WriteLine("ì‘ë‹µ í›„ì²˜ë¦¬");
});

app.Run();
```

### 5.1.2 I/O ìš”ì²­ì˜ íë¦„

```
ì‚¬ìš©ì ì• í”Œë¦¬ì¼€ì´ì…˜
     â”‚
     â”‚ CreateFile() / ReadFile() / WriteFile()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      I/O Manager                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    IRP ìƒì„±                            â”‚  â”‚
â”‚  â”‚  - ìš”ì²­ ìœ í˜• (Create, Read, Write, ...)              â”‚  â”‚
â”‚  â”‚  - íŒŒë¼ë¯¸í„° (íŒŒì¼ ì´ë¦„, ë²„í¼, í¬ê¸°, ...)             â”‚  â”‚
â”‚  â”‚  - I/O ìŠ¤íƒ ìœ„ì¹˜ ë°°ì—´                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ë“œë¼ì´ë²„ ìŠ¤íƒìœ¼ë¡œ ì „ë‹¬                    â”‚  â”‚
â”‚  â”‚  IofCallDriver(DeviceObject, Irp)                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    ë“œë¼ì´ë²„ ìŠ¤íƒ (Filter â†’ File System â†’ Volume â†’ Disk)
```

---

## 5.2 IRP (I/O Request Packet)

### 5.2.1 IRPë€?

IRPëŠ” I/O ìš”ì²­ì„ ë‚˜íƒ€ë‚´ëŠ” ë°ì´í„° êµ¬ì¡°ì…ë‹ˆë‹¤. ëª¨ë“  íŒŒì¼ ì‘ì—…(ì—´ê¸°, ì½ê¸°, ì“°ê¸°, ë‹«ê¸° ë“±)ì€ IRPë¡œ í‘œí˜„ë©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         IRP êµ¬ì¡°                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  IRP Header                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MdlAddress      - ë©”ëª¨ë¦¬ ë²„í¼ ì •ë³´                      â”‚  â”‚
â”‚  â”‚ Flags           - IRP í”Œë˜ê·¸                            â”‚  â”‚
â”‚  â”‚ IoStatus        - ê²°ê³¼ ìƒíƒœ                             â”‚  â”‚
â”‚  â”‚ UserBuffer      - ì‚¬ìš©ì ë²„í¼ í¬ì¸í„°                    â”‚  â”‚
â”‚  â”‚ Tail.Overlay    - APC, ì´ë²¤íŠ¸ ë“±                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  IO_STACK_LOCATION ë°°ì—´ (ê° ë“œë¼ì´ë²„ë§ˆë‹¤ í•˜ë‚˜ì”©)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [0] Filter Driverì˜ ìŠ¤íƒ ìœ„ì¹˜                          â”‚  â”‚
â”‚  â”‚     - MajorFunction: IRP_MJ_CREATE                     â”‚  â”‚
â”‚  â”‚     - MinorFunction: 0                                  â”‚  â”‚
â”‚  â”‚     - Parameters: ìš”ì²­ë³„ íŒŒë¼ë¯¸í„°                       â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ [1] File System Driverì˜ ìŠ¤íƒ ìœ„ì¹˜                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ [2] Volume Managerì˜ ìŠ¤íƒ ìœ„ì¹˜                         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ [3] Disk Driverì˜ ìŠ¤íƒ ìœ„ì¹˜                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2.2 ì£¼ìš” IRP Major Function ì½”ë“œ

| IRP_MJ ì½”ë“œ | ê°’ | C# ëŒ€ì‘ | ì„¤ëª… |
|------------|-----|---------|------|
| IRP_MJ_CREATE | 0x00 | File.Open() | íŒŒì¼/ë””ë ‰í„°ë¦¬ ì—´ê¸° |
| IRP_MJ_CREATE_NAMED_PIPE | 0x01 | NamedPipeServerStream | ëª…ëª…ëœ íŒŒì´í”„ ìƒì„± |
| IRP_MJ_CLOSE | 0x02 | FileStream.Dispose() | í•¸ë“¤ ë‹«ê¸° |
| IRP_MJ_READ | 0x03 | FileStream.Read() | íŒŒì¼ ì½ê¸° |
| IRP_MJ_WRITE | 0x04 | FileStream.Write() | íŒŒì¼ ì“°ê¸° |
| IRP_MJ_QUERY_INFORMATION | 0x05 | FileInfo | íŒŒì¼ ì •ë³´ ì¡°íšŒ |
| IRP_MJ_SET_INFORMATION | 0x06 | File.Move(), Delete() | íŒŒì¼ ì •ë³´ ìˆ˜ì • |
| IRP_MJ_DIRECTORY_CONTROL | 0x0C | Directory.GetFiles() | ë””ë ‰í„°ë¦¬ ì—´ê±° |
| IRP_MJ_CLEANUP | 0x12 | - | ë§ˆì§€ë§‰ í•¸ë“¤ ë‹«í˜ |

### 5.2.3 IO_STACK_LOCATION êµ¬ì¡°

```c
// IO_STACK_LOCATION êµ¬ì¡°ì²´ (ê°„ëµí™”)
// IO_STACK_LOCATION structure (simplified)
typedef struct _IO_STACK_LOCATION {
    UCHAR MajorFunction;    // IRP_MJ_CREATE, IRP_MJ_READ ë“±
    UCHAR MinorFunction;    // ì„¸ë¶€ ì‘ì—… ìœ í˜•
    UCHAR Flags;
    UCHAR Control;

    // ìš”ì²­ë³„ íŒŒë¼ë¯¸í„° (union)
    union {
        // IRP_MJ_CREATE íŒŒë¼ë¯¸í„°
        struct {
            ULONG Options;
            USHORT FileAttributes;
            USHORT ShareAccess;
            ULONG EaLength;
        } Create;

        // IRP_MJ_READ íŒŒë¼ë¯¸í„°
        struct {
            ULONG Length;
            ULONG Key;
            LARGE_INTEGER ByteOffset;
        } Read;

        // IRP_MJ_WRITE íŒŒë¼ë¯¸í„°
        struct {
            ULONG Length;
            ULONG Key;
            LARGE_INTEGER ByteOffset;
        } Write;

        // ... ë‹¤ë¥¸ MajorFunctionë³„ íŒŒë¼ë¯¸í„°
    } Parameters;

    PDEVICE_OBJECT DeviceObject;  // ëŒ€ìƒ ì¥ì¹˜
    PFILE_OBJECT FileObject;      // íŒŒì¼ ê°ì²´
    PIO_COMPLETION_ROUTINE CompletionRoutine;  // ì™„ë£Œ ë£¨í‹´

} IO_STACK_LOCATION, *PIO_STACK_LOCATION;
```

### 5.2.4 IRP ì²˜ë¦¬ ì˜ˆì‹œ

```c
// ë ˆê±°ì‹œ ë“œë¼ì´ë²„ì—ì„œ IRP ì²˜ë¦¬
// IRP handling in legacy driver
NTSTATUS MyDispatchCreate(
    PDEVICE_OBJECT DeviceObject,
    PIRP Irp
)
{
    // í˜„ì¬ I/O ìŠ¤íƒ ìœ„ì¹˜ ì–»ê¸°
    // Get current I/O stack location
    PIO_STACK_LOCATION irpSp = IoGetCurrentIrpStackLocation(Irp);

    // íŒŒì¼ ê°ì²´ ì–»ê¸°
    PFILE_OBJECT fileObject = irpSp->FileObject;

    DbgPrint("Creating: %wZ\n", &fileObject->FileName);

    // ìš”ì²­ì„ ë‹¤ìŒ ë“œë¼ì´ë²„ë¡œ ì „ë‹¬
    // Pass request to next driver
    IoSkipCurrentIrpStackLocation(Irp);
    return IoCallDriver(NextDeviceObject, Irp);
}
```

---

## 5.3 íŒŒì¼ ì‹œìŠ¤í…œ ë“œë¼ì´ë²„ ìŠ¤íƒ

### 5.3.1 ìŠ¤íƒ êµ¬ì¡°

íŒŒì¼ I/O ìš”ì²­ì€ ì—¬ëŸ¬ ë“œë¼ì´ë²„ë¥¼ ê±°ì³ ì²˜ë¦¬ë©ë‹ˆë‹¤:

```
          ì‚¬ìš©ì ìš”ì²­: File.Open("C:\\Documents\\test.txt")
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      I/O Manager                         â”‚
    â”‚                      (IRP ìƒì„±)                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ IRP
                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Filter Manager                        â”‚
    â”‚                    (fltmgr.sys)                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ Minifilter 1 (Altitude 385100) - ì•ˆí‹°ë°”ì´ëŸ¬ìŠ¤     â”‚  â”‚
    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
    â”‚  â”‚ Minifilter 2 (Altitude 365000) - ë°±ì—…             â”‚  â”‚
    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
    â”‚  â”‚ Minifilter 3 (Altitude 320000) - ìš°ë¦¬ DRM í•„í„°    â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                File System Driver                        â”‚
    â”‚                (ntfs.sys, refs.sys)                      â”‚
    â”‚  - íŒŒì¼ ì‹œìŠ¤í…œ ë©”íƒ€ë°ì´í„° ê´€ë¦¬                           â”‚
    â”‚  - íŒŒì¼/ë””ë ‰í„°ë¦¬ êµ¬ì¡° ì²˜ë¦¬                               â”‚
    â”‚  - ìºì‹± ê´€ë¦¬                                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Volume Manager                        â”‚
    â”‚                    (volmgr.sys)                          â”‚
    â”‚  - ë³¼ë¥¨ ê´€ë¦¬ (íŒŒí‹°ì…˜)                                    â”‚
    â”‚  - RAID, ë™ì  ë””ìŠ¤í¬                                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     Disk Driver                          â”‚
    â”‚                     (disk.sys)                           â”‚
    â”‚  - ë¬¼ë¦¬ì  ë””ìŠ¤í¬ ì ‘ê·¼                                    â”‚
    â”‚  - ì„¹í„° ë‹¨ìœ„ ì½ê¸°/ì“°ê¸°                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                         ë¬¼ë¦¬ ë””ìŠ¤í¬
```

### 5.3.2 ìš”ì²­ íë¦„ê³¼ ì™„ë£Œ íë¦„

```
ìš”ì²­ íë¦„ (Top-Down):           ì™„ë£Œ íë¦„ (Bottom-Up):
      â”‚                              â†‘
      â–¼                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Minifilter â”‚ â”€â”€Pre-opâ”€â”€â”€â”€â–¶ â”‚  Minifilter â”‚ â”€â”€Post-opâ”€â”€â–¶
â”‚   (ìƒìœ„)    â”‚                â”‚   (ìƒìœ„)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                              â†‘
      â–¼                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Minifilter â”‚ â”€â”€Pre-opâ”€â”€â”€â”€â–¶ â”‚  Minifilter â”‚ â”€â”€Post-opâ”€â”€â–¶
â”‚   (í•˜ìœ„)    â”‚                â”‚   (í•˜ìœ„)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                              â†‘
      â–¼                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File System â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ File System â”‚
â”‚   Driver    â”‚  ì‹¤ì œ ì²˜ë¦¬    â”‚   Driver    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5.4 Filter Manager

### 5.4.1 Filter Managerì˜ ë“±ì¥ ë°°ê²½

ê³¼ê±°ì˜ ë ˆê±°ì‹œ íŒŒì¼ ì‹œìŠ¤í…œ í•„í„° ë“œë¼ì´ë²„ëŠ” ë§ì€ ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤:

```
ë ˆê±°ì‹œ í•„í„° ë“œë¼ì´ë²„ì˜ ë¬¸ì œì :
â”œâ”€â”€ ìŠ¤íƒ ìˆœì„œ ê´€ë¦¬ ì–´ë ¤ì›€
â”‚   - ì–´ë–¤ í•„í„°ê°€ ë¨¼ì € ë¡œë“œë ì§€ ì˜ˆì¸¡ ë¶ˆê°€
â”‚   - í•„í„° ê°„ ì¶©ëŒ ë¹ˆë²ˆ
â”œâ”€â”€ ë³µì¡í•œ IRP ì²˜ë¦¬
â”‚   - ëª¨ë“  IRP ìœ í˜•ì„ ì§ì ‘ ì²˜ë¦¬í•´ì•¼ í•¨
â”‚   - ë§ì€ ìƒìš©êµ¬ ì½”ë“œ í•„ìš”
â”œâ”€â”€ ì–¸ë¡œë“œ ë¶ˆì•ˆì •
â”‚   - ì•ˆì „í•œ ì–¸ë¡œë“œ ë³´ì¥ ì–´ë ¤ì›€
â”‚   - ì‹œìŠ¤í…œ ì¬ì‹œì‘ í•„ìš”í•œ ê²½ìš° ë§ìŒ
â””â”€â”€ ìœ ì§€ë³´ìˆ˜ ì–´ë ¤ì›€
    - ê° í•„í„°ê°€ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘
    - ë””ë²„ê¹… ë³µì¡
```

### 5.4.2 Filter Manager ì•„í‚¤í…ì²˜

Filter Manager(fltmgr.sys)ëŠ” ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Filter Manager (fltmgr.sys)               â”‚
â”‚                                                              â”‚
â”‚  ì—­í• :                                                       â”‚
â”‚  â”œâ”€â”€ Minifilter ë¡œë“œ/ì–¸ë¡œë“œ ê´€ë¦¬                             â”‚
â”‚  â”œâ”€â”€ Altitude ê¸°ë°˜ ìŠ¤íƒ ìˆœì„œ ê´€ë¦¬                            â”‚
â”‚  â”œâ”€â”€ IRP â†’ Callback Data ë³€í™˜                                â”‚
â”‚  â”œâ”€â”€ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ ì§€ì›                                      â”‚
â”‚  â””â”€â”€ ì•ˆì „í•œ ì–¸ë¡œë“œ ë³´ì¥                                      â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Minifilter ì¸ìŠ¤í„´ìŠ¤ë“¤                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Minifilter A (Altitude 385100)                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   Instance 1 (C: ë“œë¼ì´ë¸Œ)                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   Instance 2 (D: ë“œë¼ì´ë¸Œ)                      â”‚  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ â”‚
â”‚  â”‚  â”‚ Minifilter B (Altitude 365000)                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   Instance 1 (C: ë“œë¼ì´ë¸Œ)                      â”‚  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ â”‚
â”‚  â”‚  â”‚ Minifilter C (Altitude 320000) â† ìš°ë¦¬ í•„í„°      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   Instance 1 (C: ë“œë¼ì´ë¸Œ)                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   Instance 2 (D: ë“œë¼ì´ë¸Œ)                      â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4.3 Altitude (ê³ ë„) ê°œë…

**Altitude**ëŠ” Minifilterì˜ ìŠ¤íƒ ë‚´ ìœ„ì¹˜ë¥¼ ê²°ì •í•˜ëŠ” ìˆ«ìì…ë‹ˆë‹¤:

```
ë†’ì€ Altitude (íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ë©€ë¦¬)
â”‚
â”‚   Altitude 400000-409999: Activity Monitor (ëª¨ë‹ˆí„°ë§)
â”‚       â””â”€ ìš”ì²­ì„ ê°€ì¥ ë¨¼ì € ë´„
â”‚
â”‚   Altitude 360000-389999: Anti-Virus (ì•ˆí‹°ë°”ì´ëŸ¬ìŠ¤)
â”‚       â””â”€ ì•…ì„±ì½”ë“œ ê²€ì‚¬
â”‚
â”‚   Altitude 320000-329999: Encryption (ì•”í˜¸í™”) â† ìš°ë¦¬ DRM
â”‚       â””â”€ íŒŒì¼ ì•”í˜¸í™”/ë³µí˜¸í™”
â”‚
â”‚   Altitude 300000-309999: Compression (ì••ì¶•)
â”‚       â””â”€ íŒŒì¼ ì••ì¶•/í•´ì œ
â”‚
â”‚   Altitude 180000-189999: HSM (ê³„ì¸µì  ì €ì¥ì†Œ ê´€ë¦¬)
â”‚
â–¼
ë‚®ì€ Altitude (íŒŒì¼ ì‹œìŠ¤í…œì— ê°€ê¹Œì´)
```

### Altitude ë²”ìœ„ í‘œ

| Altitude ë²”ìœ„ | ê·¸ë£¹ ì´ë¦„ | ìš©ë„ |
|--------------|----------|------|
| 420000-429999 | FSFilter Top | ìµœìƒìœ„ í•„í„° |
| 400000-409999 | FSFilter Activity Monitor | í™œë™ ëª¨ë‹ˆí„°ë§ |
| 360000-389999 | FSFilter Anti-Virus | ì•ˆí‹°ë°”ì´ëŸ¬ìŠ¤ |
| 340000-349999 | FSFilter Replication | ë³µì œ |
| 320000-329999 | FSFilter Encryption | ì•”í˜¸í™” |
| 300000-309999 | FSFilter Compression | ì••ì¶• |
| 260000-269999 | FSFilter Virtualization | ê°€ìƒí™” |
| 220000-229999 | FSFilter Physical Quota Mgmt | í• ë‹¹ëŸ‰ ê´€ë¦¬ |
| 180000-189999 | FSFilter HSM | ê³„ì¸µì  ì €ì¥ì†Œ |
| 140000-149999 | FSFilter Copy Protection | ë³µì‚¬ ë°©ì§€ |
| 100000-109999 | FSFilter Security Enhancer | ë³´ì•ˆ ê°•í™” |
| 80000-89999 | FSFilter Bottom | ìµœí•˜ìœ„ í•„í„° |

> ğŸ’¡ **ì°¸ê³ **: Altitude ê°’ì€ Microsoftì—ì„œ ê³µì‹ í• ë‹¹ë°›ì•„ì•¼ í•©ë‹ˆë‹¤. ê°œë°œ/í…ŒìŠ¤íŠ¸ ì‹œì—ëŠ” ì„ì‹œ ê°’ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## 5.5 Minifilter ê°œìš”

### 5.5.1 Minifilterë€?

MinifilterëŠ” Filter Managerì— ë“±ë¡ë˜ëŠ” **ê²½ëŸ‰ íŒŒì¼ ì‹œìŠ¤í…œ í•„í„° ë“œë¼ì´ë²„**ì…ë‹ˆë‹¤:

```
Minifilterì˜ íŠ¹ì§•:
â”œâ”€â”€ IRP ëŒ€ì‹  Callback Data ì‚¬ìš©
â”‚   â””â”€ ë” ê°„ë‹¨í•˜ê³  ì¼ê´€ëœ ì¸í„°í˜ì´ìŠ¤
â”œâ”€â”€ ì½œë°± ê¸°ë°˜ ëª¨ë¸
â”‚   â””â”€ ê´€ì‹¬ ìˆëŠ” ì‘ì—…ë§Œ ë“±ë¡
â”œâ”€â”€ Filter Managerê°€ ìŠ¤íƒ ê´€ë¦¬
â”‚   â””â”€ Altitudeë¡œ ìˆœì„œ ìë™ ê²°ì •
â”œâ”€â”€ ì•ˆì „í•œ ë¡œë“œ/ì–¸ë¡œë“œ
â”‚   â””â”€ Filter Managerê°€ ë³´ì¥
â””â”€â”€ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ ì§€ì›
    â””â”€ íŒŒì¼/ë³¼ë¥¨ë³„ ë°ì´í„° ì €ì¥ ìš©ì´
```

### 5.5.2 ë ˆê±°ì‹œ í•„í„° vs Minifilter ë¹„êµ

| íŠ¹ì„± | ë ˆê±°ì‹œ í•„í„° | Minifilter |
|------|-----------|------------|
| IRP ì²˜ë¦¬ | ì§ì ‘ ì²˜ë¦¬ | Callback Data ì‚¬ìš© |
| ìŠ¤íƒ ìˆœì„œ | ë¡œë“œ ìˆœì„œ ì˜ì¡´ | Altitudeë¡œ ê²°ì • |
| ë“±ë¡ | IoAttachDeviceToDeviceStack | FltRegisterFilter |
| ì–¸ë¡œë“œ | ë³µì¡, ë¶ˆì•ˆì • | ì•ˆì „í•˜ê²Œ ë³´ì¥ |
| ì½”ë“œëŸ‰ | ë§ìŒ | ì ìŒ |
| ì»¨í…ìŠ¤íŠ¸ | ì§ì ‘ ê´€ë¦¬ | ì‹œìŠ¤í…œ ì§€ì› |

### 5.5.3 Minifilter ê¸°ë³¸ êµ¬ì¡°

```c
// Minifilter ê¸°ë³¸ êµ¬ì¡° (ê°œë…)
// Basic Minifilter structure (concept)

// 1. í•„í„° ë“±ë¡ ì •ë³´
const FLT_REGISTRATION FilterRegistration = {
    sizeof(FLT_REGISTRATION),        // êµ¬ì¡°ì²´ í¬ê¸°
    FLT_REGISTRATION_VERSION,        // ë²„ì „
    0,                               // í”Œë˜ê·¸
    ContextRegistration,             // ì»¨í…ìŠ¤íŠ¸ ë“±ë¡
    OperationCallbacks,              // ì½œë°± ë“±ë¡
    FilterUnload,                    // ì–¸ë¡œë“œ ì½œë°±
    InstanceSetup,                   // ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •
    InstanceQueryTeardown,           // ì¸ìŠ¤í„´ìŠ¤ í•´ì œ ì¿¼ë¦¬
    InstanceTeardownStart,           // ì¸ìŠ¤í„´ìŠ¤ í•´ì œ ì‹œì‘
    InstanceTeardownComplete,        // ì¸ìŠ¤í„´ìŠ¤ í•´ì œ ì™„ë£Œ
};

// 2. ì‘ì—… ì½œë°± ë“±ë¡
const FLT_OPERATION_REGISTRATION OperationCallbacks[] = {
    { IRP_MJ_CREATE, 0, PreCreate, PostCreate },
    { IRP_MJ_WRITE, 0, PreWrite, NULL },
    { IRP_MJ_SET_INFORMATION, 0, PreSetInfo, NULL },
    { IRP_MJ_OPERATION_END }
};

// 3. Pre-operation ì½œë°± ì˜ˆì‹œ
FLT_PREOP_CALLBACK_STATUS
PreCreate(
    PFLT_CALLBACK_DATA Data,
    PCFLT_RELATED_OBJECTS FltObjects,
    PVOID *CompletionContext
)
{
    // íŒŒì¼ ìƒì„±/ì—´ê¸° ì „ì— í˜¸ì¶œë¨
    // Called before file create/open

    PFLT_FILE_NAME_INFORMATION nameInfo;
    NTSTATUS status = FltGetFileNameInformation(
        Data,
        FLT_FILE_NAME_NORMALIZED,
        &nameInfo
    );

    if (NT_SUCCESS(status)) {
        DbgPrint("PreCreate: %wZ\n", &nameInfo->Name);
        FltReleaseFileNameInformation(nameInfo);
    }

    return FLT_PREOP_SUCCESS_WITH_CALLBACK;  // Post ì½œë°± í˜¸ì¶œ
}
```

### 5.5.4 Callback Data vs IRP

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IRP (ë ˆê±°ì‹œ)                    â”‚ Callback Data (Minifilter) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë³µì¡í•œ êµ¬ì¡°                     â”‚ ê°„ë‹¨í•œ êµ¬ì¡°                  â”‚
â”‚ IO_STACK_LOCATION ë°°ì—´          â”‚ Iopb (I/O Parameter Block)  â”‚
â”‚ ì§ì ‘ ì™„ë£Œ ì²˜ë¦¬                  â”‚ Filter Managerê°€ ê´€ë¦¬        â”‚
â”‚ ë‹¤ìŒ ë“œë¼ì´ë²„ ì§ì ‘ í˜¸ì¶œ         â”‚ FLT_PREOP_SUCCESS_* ë°˜í™˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5.6 Fast I/O

### 5.6.1 Fast I/Oë€?

**Fast I/O**ëŠ” IRP ìƒì„± ì—†ì´ ìºì‹œëœ ë°ì´í„°ì— ì§ì ‘ ì ‘ê·¼í•˜ëŠ” ìµœì í™” ê²½ë¡œì…ë‹ˆë‹¤:

```
ì¼ë°˜ I/O ê²½ë¡œ:               Fast I/O ê²½ë¡œ:
     â”‚                            â”‚
     â–¼                            â–¼
 IRP ìƒì„±                    Fast I/O ì‹œë„
     â”‚                            â”‚
     â–¼                       ì„±ê³µ? â”€â”¬â”€ ì˜ˆ â†’ ì§ì ‘ ìºì‹œ ì ‘ê·¼
ë“œë¼ì´ë²„ ìŠ¤íƒ                     â”‚       (IRP ì—†ìŒ)
     â”‚                            â”‚
     â–¼                       ì•„ë‹ˆì˜¤
íŒŒì¼ ì‹œìŠ¤í…œ                       â”‚
     â”‚                            â–¼
     â–¼                       ì¼ë°˜ I/Oë¡œ ì „í™˜
   ì™„ë£Œ                      (IRP ìƒì„±)
```

### 5.6.2 Minifilterì—ì„œì˜ Fast I/O

```c
// MinifilterëŠ” Fast I/Oë„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ
// Minifilter can also handle Fast I/O
const FLT_OPERATION_REGISTRATION OperationCallbacks[] = {
    { IRP_MJ_READ,
      FLTFL_OPERATION_REGISTRATION_SKIP_CACHED_IO,  // ìºì‹œ I/O ê±´ë„ˆë›°ê¸°
      PreRead,
      PostRead },
    { IRP_MJ_OPERATION_END }
};
```

---

## ì •ë¦¬

### í•µì‹¬ ê°œë…

| ê°œë… | ì„¤ëª… |
|------|------|
| **I/O Manager** | ëª¨ë“  I/O ìš”ì²­ì„ ê´€ë¦¬, IRP ìƒì„± |
| **IRP** | I/O Request Packet, I/O ìš”ì²­ì„ ë‚˜íƒ€ë‚´ëŠ” êµ¬ì¡°ì²´ |
| **Filter Manager** | Minifilterë¥¼ ê´€ë¦¬í•˜ëŠ” ì‹œìŠ¤í…œ ë“œë¼ì´ë²„ |
| **Minifilter** | ê²½ëŸ‰ íŒŒì¼ ì‹œìŠ¤í…œ í•„í„°, ì½œë°± ê¸°ë°˜ |
| **Altitude** | Minifilterì˜ ìŠ¤íƒ ë‚´ ìœ„ì¹˜ (ìˆ«ì) |
| **Callback Data** | Minifilterê°€ ë°›ëŠ” I/O ìš”ì²­ ë°ì´í„° |

### I/O íë¦„ ìš”ì•½

```
Application â†’ I/O Manager â†’ Filter Manager â†’ Minifilters â†’ File System
                                  â†‘
                            ìš°ë¦¬ ë“œë¼ì´ë²„ê°€
                            ì—¬ê¸°ì— ìœ„ì¹˜
```

### ë‹¤ìŒ ì¥ ë¯¸ë¦¬ë³´ê¸°

Chapter 6ì—ì„œëŠ” Windows ë³´ì•ˆ ëª¨ë¸ì„ ë‹¤ë£¹ë‹ˆë‹¤:
- ë³´ì•ˆ ì£¼ì²´ì™€ SID
- ì•¡ì„¸ìŠ¤ í† í°
- ì ‘ê·¼ ì œì–´ (ACL)
- ë¬´ê²°ì„± ìˆ˜ì¤€

---

## ì—°ìŠµ ë¬¸ì œ

### 1. IRP Major Function

ë‹¤ìŒ C# ì½”ë“œê°€ ë°œìƒì‹œí‚¤ëŠ” IRP_MJ ì½”ë“œëŠ”?

```csharp
File.Delete("C:\\test.txt");
```

### 2. Altitude

ë‹¤ìŒ ì¤‘ íŒŒì¼ ìš”ì²­ì„ ê°€ì¥ ë¨¼ì € ë³´ëŠ” MinifilterëŠ”?

- [ ] Altitude 320000 (ì•”í˜¸í™”)
- [ ] Altitude 365000 (ì•ˆí‹°ë°”ì´ëŸ¬ìŠ¤)
- [ ] Altitude 400000 (ëª¨ë‹ˆí„°ë§)

### 3. Filter Managerì˜ ì—­í• 

ë ˆê±°ì‹œ í•„í„° ëŒ€ë¹„ Minifilter/Filter Managerì˜ ì¥ì  3ê°€ì§€ë¥¼ ì„¤ëª…í•˜ì„¸ìš”.

---

## ì°¸ê³  ìë£Œ

- [Filter Manager Concepts](https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/filter-manager-concepts)
- [File System Minifilter Drivers](https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/file-system-minifilter-drivers)
- [Allocated Filter Altitudes](https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/allocated-altitudes)
